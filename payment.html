<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Page</title>
    <!-- Add date picker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    <style>
        /* Google Font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #f4f7fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: #ffffff;
            padding: 40px;
            width: 400px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
            transition: transform 0.3s ease-in-out;
        }

        .container:hover {
            transform: scale(1.02);
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
            text-transform: uppercase;
        }

        input, select {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            outline: none;
            background: #f9f9f9;
            font-size: 16px;
            transition: 0.3s ease-in-out;
        }

        .display-field {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #f0f0f0;
            font-size: 16px;
            text-align: left;
        }

        input:focus, select:focus {
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
            background: white;
        }

        button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: 0.3s;
            margin-top: 10px;
        }

        .pay-btn {
            background: #4CAF50;
            color: white;
        }

        .pay-btn:hover {
            background: #45a049;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .back-btn {
            background: #ccc;
            color: black;
        }

        .back-btn:hover {
            background: #bbb;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }

        .error-message {
            color: red;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .price-display {
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .loading {
            display: none;
            margin: 10px 0;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4CAF50;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .date-picker-container {
            margin: 10px 0;
        }

        .date-range-display {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .time-picker-container {
    margin: 10px 0;
}

.time-display {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
}


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .container {
                width: 90%;
            }

            input, select, button, .display-field {
                font-size: 14px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Complete Your Payment</h2>
        <form id="payment-form">
            <input type="text" id="name" placeholder="Enter your name" required>
            <input type="email" id="email" placeholder="Enter your email" required>
            <input type="tel" id="phone" placeholder="Enter your phone number" pattern="[6-9][0-9]{9}" title="10-digit Indian phone number starting with 6-9" required>
            <input type="number" id="age" placeholder="Enter your age" min="18" max="110" required>

            <input type="text" id="location-name" placeholder="Location Name" readonly class="display-field">
            
            <div class="display-field" id="vehicle-type-display">Vehicle Type: Not Selected</div>
            <div class="display-field" id="model-name-display">Model: Not Selected</div>

            <select id="rent-duration" required>
                <option value="">Select Rent Duration</option>
                <option value="Hourly">Hourly</option>
                <option value="Daily">Daily</option>
            </select>

            <input type="number" id="hours" placeholder="Enter number of hours" min="1" class="hidden">
            <input type="number" id="days" placeholder="Enter number of days" min="1" class="hidden">

            <div class="date-picker-container">
                <input type="text" id="rental-dates" placeholder="Select rental dates" readonly>
                <div class="date-range-display" id="date-range-display"></div>
            </div>

            <div class="time-picker-container">
                <input type="text" id="rental-time" placeholder="Select rental time" readonly>
                <div class="time-display" id="time-display"></div>
            </div>
            

            <div class="price-display" id="price-display">Total Price: â‚¹0</div>

            <div class="error-message" id="error-message">Please fill in all the required fields correctly.</div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Processing your payment...</p>
            </div>

            <button type="button" class="pay-btn" id="pay-btn">Pay Now</button>
            <button type="button" class="back-btn" id="back-btn">Back</button>
        </form>
    </div>
    
    <!-- Add date picker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script>
        // Vehicle pricing data
        const vehiclePrices = {
            "Car": {
                "Maruti Suzuki Swift": { hourly: [100, 200], daily: [800, 1500] },
                "Honda City": { hourly: [200, 400], daily: [1500, 3000] },
                "Toyota Fortuner": { hourly: [500, 700], daily: [3500, 6000] },
                "Mercedes-Benz E-Class": { hourly: [1500, 2500], daily: [10000, 20000] },
                "Tata Nexon EV": { hourly: [300, 500], daily: [2000, 4000] },
                "Mini Cooper Convertible": { hourly: [2000, 3000], daily: [15000, 25000] }
            },
            "Bike": {
                "Bajaj Avenger 220": { hourly: [50, 100], daily: [750, 750] },
                "Yamaha R15": { hourly: [80, 150], daily: [900, 900] },
                "Royal Enfield Himalayan": { hourly: [120, 200], daily: [1200, 1200] },
                "Honda Shine": { hourly: [30, 60], daily: [500, 500] },
                "Ather 450X": { hourly: [40, 80], daily: [700, 700] }
            },
            "Bus": {
                "Volvo B11R": { hourly: [1500, 2500], daily: [18000, 18000] },
                "Force Traveller 26": { hourly: [700, 1200], daily: [10000, 10000] },
                "Ashok Leyland Lynx": { hourly: [600, 1000], daily: [8000, 8000] },
                "Tata Starbus": { hourly: [800, 1500], daily: [12000, 12000] }
            },
            "Truck": {
                "Tata 407": { hourly: [200, 300], daily: [1500, 2500] },
                "Ashok Leyland Ecomet": { hourly: [400, 600], daily: [3000, 5000] },
                "Tata LPT 1613": { hourly: [600, 800], daily: [5000, 8000] },
                "BharatBenz 2823R": { hourly: [1000, 1500], daily: [8000, 12000] },
                "Ashok Leyland U 2518": { hourly: [800, 1200], daily: [7000, 10000] },
                "Tata Signa 5525": { hourly: [1500, 2000], daily: [10000, 20000] }
            }
        };

        document.addEventListener("DOMContentLoaded", function() {
            // Initialize date picker
            const datePicker = flatpickr("#rental-dates", {
                
                minDate: "today",
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr, instance) {
                    updateDateRangeDisplay(selectedDates);
                    calculatePrice();
                }
            });

            // Initialize time picker
    const timePicker = flatpickr("#rental-time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        onChange: function(selectedDates, dateStr, instance) {
            updateTimeDisplay(dateStr);
            calculatePrice();
        }
    });

    function updateTimeDisplay(time) {
        const timeDisplay = document.getElementById('time-display');
        if (time) {
            timeDisplay.textContent = `Rental time: ${time}`;
        } else {
            timeDisplay.textContent = '';
        }
    }


    function updateDateDisplay(selectedDates) {
        const displayElement = document.getElementById('date-display');
        if (selectedDates.length === 1) {
            const startDate = selectedDates[0];
            displayElement.textContent = `Rental start date: ${startDate.toDateString()}`;
        } else {
            displayElement.textContent = '';
        }
    }

            // Get stored data
            var storedData = JSON.parse(localStorage.getItem("selectedLocation"));
            var rentalDuration = localStorage.getItem("rentalDuration");
            var durationType = localStorage.getItem("durationType");
            var selectedVehicle = JSON.parse(localStorage.getItem("selectedVehicle"));

            // Pre-fill Location Name
            if (storedData) {
                document.getElementById("location-name").value = storedData.location;
            }

            // Pre-fill Vehicle Information
            if (selectedVehicle) {
                document.getElementById("vehicle-type-display").textContent = "Vehicle Type: " + selectedVehicle.category;
                document.getElementById("model-name-display").textContent = "Model: " + selectedVehicle.model;
                localStorage.removeItem("selectedVehicle");
            }

            // Pre-fill Rent Duration
            if (rentalDuration && durationType) {
                document.getElementById("rent-duration").value = durationType === "hours" ? "Hourly" : "Daily";
                if (durationType === "hours") {
                    document.getElementById("hours").classList.remove("hidden");
                    document.getElementById("hours").value = rentalDuration;
                } else {
                    document.getElementById("days").classList.remove("hidden");
                    document.getElementById("days").value = rentalDuration;
                }
            }

            // Calculate and display initial price
            calculatePrice();

            // Toggle hours/days fields and recalculate price
            document.getElementById("rent-duration").addEventListener("change", function() {
                if (this.value === "Hourly") {
                    document.getElementById("hours").classList.remove("hidden");
                    document.getElementById("days").classList.add("hidden");
                } else if (this.value === "Daily") {
                    document.getElementById("days").classList.remove("hidden");
                    document.getElementById("hours").classList.add("hidden");
                } else {
                    document.getElementById("hours").classList.add("hidden");
                    document.getElementById("days").classList.add("hidden");
                }
                calculatePrice();
            });

            // Recalculate price when hours/days change
            document.getElementById("hours").addEventListener("input", calculatePrice);
            document.getElementById("days").addEventListener("input", calculatePrice);

            // Real-time validation
            document.getElementById('phone').addEventListener('input', function() {
                var phoneRegex = /^[6-9]\d{0,9}$/;
                if (!phoneRegex.test(this.value)) {
                    this.style.borderColor = "red";
                } else {
                    this.style.borderColor = "#ccc";
                }
            });

            // Calculate price based on selected vehicle and duration
            function calculatePrice() {
                const vehicleType = document.getElementById("vehicle-type-display").textContent.replace("Vehicle Type: ", "");
                const modelName = document.getElementById("model-name-display").textContent.replace("Model: ", "");
                const durationType = document.getElementById("rent-duration").value;
                const hours = parseInt(document.getElementById("hours").value) || 0;
                const days = parseInt(document.getElementById("days").value) || 0;
                const selectedDates = datePicker.selectedDates;

                let price = 0;
                
                if (vehicleType && modelName && vehiclePrices[vehicleType] && vehiclePrices[vehicleType][modelName]) {
                    const pricing = vehiclePrices[vehicleType][modelName];
                    
                    if (durationType === "Hourly" && hours > 0) {
                        const avgHourlyPrice = (pricing.hourly[0] + pricing.hourly[1]) / 2;
                        price = avgHourlyPrice * hours;
                    } else if (durationType === "Daily" && days > 0) {
                        const avgDailyPrice = (pricing.daily[0] + pricing.daily[1]) / 2;
                        price = avgDailyPrice * days;
                    } else if (durationType === "Daily" && selectedDates.length === 2) {
                        // Calculate days from date range if available
                        const startDate = selectedDates[0];
                        const endDate = selectedDates[1];
                        const diffTime = Math.abs(endDate - startDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        const avgDailyPrice = (pricing.daily[0] + pricing.daily[1]) / 2;
                        price = avgDailyPrice * diffDays;
                    }
                }

                document.getElementById("price-display").textContent = `Total Price: â‚¹${price.toFixed(2)}`;
            }

            // Validate form data
            function validateForm() {
                const name = document.getElementById("name").value.trim();
                const email = document.getElementById("email").value.trim();
                const phone = document.getElementById("phone").value.trim();
                const age = document.getElementById("age").value.trim();
                const location = document.getElementById("location-name").value.trim();
                const vehicleType = document.getElementById("vehicle-type-display").textContent.replace("Vehicle Type: ", "").trim();
                const model = document.getElementById("model-name-display").textContent.replace("Model: ", "").trim();
                const duration = document.getElementById("rent-duration").value;
                const durationValue = duration === "Hourly" ? document.getElementById("hours").value.trim() : document.getElementById("days").value.trim();
                const rentalDates = datePicker.selectedDates;
                const totalPriceText = document.getElementById("price-display").textContent.replace("Total Price: â‚¹", "").trim();
                const totalPrice = parseFloat(totalPriceText);

                const errors = [];

                // Field presence validation
                if (!name) errors.push("Name is required");
                if (!email) errors.push("Email is required");
                if (!phone) errors.push("Phone number is required");
                if (!age) errors.push("Age is required");
                if (!location) errors.push("Location is required");
                if (vehicleType === "Not Selected") errors.push("Vehicle type is required");
                if (model === "Not Selected") errors.push("Vehicle model is required");
                if (!duration) errors.push("Rental duration is required");
                
                
                
                // Duration validation
                if (duration === "Hourly" && !durationValue) {
                    errors.push("Hours value is required");
                } else if (duration === "Daily" && !durationValue && rentalDates.length !== 2) {
                    errors.push("Either days value or date range is required");
                }
                
                if (isNaN(totalPrice) || totalPrice <= 0) errors.push("Invalid price calculation");

                // Format validation
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    errors.push("Please enter a valid email address");
                }

                if (phone && !/^[6-9]\d{9}$/.test(phone)) {
                    errors.push("Please enter a valid 10-digit Indian phone number");
                }

                if (age && (parseInt(age) < 18 || parseInt(age) > 110)) {
                    errors.push("Age must be between 18 and 110 years");
                }

                return {
                    isValid: errors.length === 0,
                    errors,
                    formData: { 
                        name, 
                        email, 
                        phone, 
                        age, 
                        location, 
                        vehicleType, 
                        model, 
                        duration, 
                        durationValue,
                        startDate: rentalDates.length > 0 ? rentalDates[0].toISOString() : null,
                        endDate: rentalDates.length > 1 ? rentalDates[1].toISOString() : null,
                        totalPrice 
                    }
                };
            }

            // Process payment
            document.getElementById('pay-btn').addEventListener('click', function() {
                const validation = validateForm();
                
                if (!validation.isValid) {
                    alert("Please fix the following errors:\n\n" + validation.errors.join("\n"));
                    return;
                }

                // Show loading spinner
                document.getElementById('loading').style.display = 'block';
                document.getElementById('pay-btn').disabled = true;

                fetch("http://localhost:5000/process-payment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(validation.formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirectUrl;
                    } else {
                        alert("Payment failed: " + (data.message || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Payment processing error. Please try again.");
                })
                .finally(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('pay-btn').disabled = false;
                });
            });

            // Back button
            document.getElementById('back-btn').addEventListener('click', function() {
                window.location.href = "map.html";
            });
        });
    </script>
</body>
</html>