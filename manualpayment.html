<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Payment</title>
    <style>
        /* Google Font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(to right, #66b7ea, #4b75a2);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.2);
            padding: 30px;
            width: 420px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            color: white;
        }

        h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .payment-details {
            text-align: left;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        .payment-details p {
            font-size: 16px;
            margin: 6px 0;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 10px auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        input, button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .submit-btn {
            background: #4CAF50;
            color: white;
        }

        .submit-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .back-btn {
            background: #ccc;
            color: black;
        }

        .back-btn:hover {
            background: #bbb;
            transform: scale(1.05);
        }

        #status {
            margin-top: 15px;
            font-weight: bold;
            color: white;
            min-height: 20px;
        }

        .error { color: #dc3545; }
        .success { color: #28a745; }
        .progress { color: #17a2b8; }

        .hidden { display: none; }

        @media (max-width: 480px) {
            .container { width: 90%; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
</head>
<body>

    <div class="container">
        <h2>Complete Your Payment</h2>

        <div class="payment-details">
            <p><strong>UPI ID:</strong> ritikrajput619123456@okaxis</p>
            <p><strong>Bank Name:</strong> Bank of Baroda</p>
            <p><strong>Account Number:</strong> 27820100015584</p>
            <p><strong>IFSC Code:</strong> BARB0MAHULH</p>
        </div>

        <img src="assets/QR.jpeg" alt="Scan QR to Pay" class="qr-code">

        <p><strong>Upload Payment Screenshot:</strong></p>
        <input type="file" id="paymentScreenshot" accept="image/*">

        <button class="submit-btn" id="uploadBtn">Submit Payment</button>
        <button class="back-btn" id="back-btn">Back</button>

        <p id="status"></p>
    </div>

    <script>
        const DROPBOX_ACCESS_TOKEN = "sl.u.AFqiiUjgz0i5M8SY1HKgYoAYuV9jnUsqqJX9NcuzZGBS71I2TVPJaSEuDMAJdOa79zu_19IHeuSVWRj6pPCjJSouByST5DyiEPGMWGMCDNZnlNowy1gEtc6i1_VEU6hdWuUMxlEbbUsW5vWfbymUkrm-rT1WvCMGIOIBNlvbrvAJ6XrHc4mjmJeo6jBA0NNdQqTOVHE-ZUoG7seCa7LFDNVPsnSVs5LEvmSASRBh4nT0SzOq1UgRhMvifTNV4wzwkEjINpzWHcEymOohBYJzw6Ew_E5CkHJ1DQwQ-huAfjQwTIIgiD4ryg7meAlSRNbjuvVLALj5SsXeAFFLbBn3g3k6wbrYr6oqd2iToosGcl8pXaeWAyKKdZhmJigSKSaSeBk3tMJRFp9nJc1ftewaDujt15dQjbXArVgcxGLEvAq0LEW-85lwMWM1WrQjnS16T8XrFQoXZ5Ir7ndJFCDObX5gUqrs8xuE3GirpMHf6ePLgcOBz0si0c6jm5fDviqCvgK7W1jnzX2BOkhZAUcRzhG5J2RKpIWUL7mBGcJ3ZgI_jsn5zt7jvhHorVSUdnWeTP1mLVFZ8e8Gfc7KabGhYNIUd8hy09upZm5AqBvKuNg0Wa0fu_imspjBeDjqk6BISvNB1-gDHZtGtqcvw95iDPThIv3_kcoAhLm6bl_i6Yx6VIBvAKGZJdH59lNlbXVNDz7scULvJo47idq0eS1z5nYpw1UPnNGgZyVGtvz3rvJyfLyClr59UbCQe92SLZ-2XbBHgHnzmHykUdsf3hEwrIfZOZCSmqQGLLZdr0MkwuJMghCvotqIbxJ2bSRTiA4xO7JR5O4HVisToqYABgRKRg1hS_mG1OPWDrS95iHeBBIbttzjIqE4JtQ4kmny9rEcOrhU-89RvuU7zeeHIpjHq8qVgdYQ0ZRmA383IrI3X9SWQpU05M9ZnYGLIQgzx9Oy4dVbC-TbuVwkbKeUiCwrxzMsQF_yGOZczZqS_KRRoPskOgJi_q2A3kZgk7igLVzO4lPWqfVD_rhuzowaMocka1Fy4ZjTfmsgkCa8LoTdhly0Y6JgN5prOwnjQdBzRBWt78zn-9dH_bGL4f_pMEi5EAhXmuvD2e49Cg-442jjS8TswhaQ818JqrT284Va5xv2WZw4RNYzBR9jFe7Xtuckc7oHhnclR4PUFSjij--wbrG_urung7As1pCZhNU8lfFYui4m0i4s1giDaXZTdwotjkjzqjRAhyfp1UxWBsbFXgKeNj8CxVWJ3zIEZ-ASvIIPXrN82gyrzjwGJzaSu9ckXEiWtfNIlmv_zKa-UFQ04gW46jXNSuJFy7pUqla6PeW9XXEIBpWNQqc-1KmgzDprtWu3dlfF-Uw0LxxtMdSZY-iCKH-pAMJ42hH67-juCqApvyirVabnOT153bVZjkQmjDICfFTiehDyWiJO-3TZOWiZvA";  // üî¥ Replace with your valid token

        document.getElementById("uploadBtn").addEventListener("click", uploadPaymentScreenshot);
        document.getElementById("back-btn").addEventListener("click", () => window.location.href = "payment.html");

        async function uploadPaymentScreenshot() {
            const fileInput = document.getElementById("paymentScreenshot");
            const statusElement = document.getElementById("status");
            const files = fileInput.files;

            if (files.length === 0) {
                statusElement.innerHTML = "‚ùå Please select a payment screenshot.";
                return;
            }

            if (!DROPBOX_ACCESS_TOKEN) {
                statusElement.innerHTML = "‚ùå Dropbox access token is missing!";
                return;
            }

            statusElement.innerHTML = "‚è≥ Uploading screenshot...";
            const dropbox = new Dropbox.Dropbox({
                accessToken: DROPBOX_ACCESS_TOKEN,
                fetch: window.fetch.bind(window)
            });

            try {
                const file = files[0];
                const fileContent = await readFileAsArrayBuffer(file);
                const sanitizedFileName = `payment_${Date.now()}_${file.name.replace(/[^\w.-]/g, "_")}`;
                const filePath = `/payments/${sanitizedFileName}`;

                await dropbox.filesUpload({
                    path: filePath,
                    contents: fileContent,
                    mode: "overwrite"
                });

                await logPaymentToDropbox(sanitizedFileName);

                statusElement.innerHTML = "‚úÖ Payment screenshot uploaded successfully!";
            } catch (error) {
                console.error("Dropbox error:", error);
                statusElement.innerHTML = "‚ùå Upload failed. Check console for details.";
            }
        }

        // Helper function to read file as ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error("Failed to read file"));
                reader.readAsArrayBuffer(file);
            });
        }

        // Function to log payment in a Dropbox file
        async function logPaymentToDropbox(fileName) {
            const dropbox = new Dropbox.Dropbox({
                accessToken: DROPBOX_ACCESS_TOKEN,
                fetch: window.fetch.bind(window)
            });

            const logEntry = `${new Date().toISOString()} - Payment Uploaded:\n` +
                             `   File: ${fileName}\n\n`;

            try {
                let existingLog = "";
                try {
                    const response = await dropbox.filesDownload({ path: "/payments/payment_log.txt" });
                    existingLog = new TextDecoder().decode(response.result.fileBlob);
                } catch (error) {
                    console.warn("Log file not found, creating a new one.");
                }

                const newLogContent = existingLog + logEntry;

                await dropbox.filesUpload({
                    path: "/payments/payment_log.txt",
                    contents: newLogContent,
                    mode: "overwrite"
                });

                console.log("üìú Payment log updated successfully!");
            } catch (err) {
                console.error("‚ùå Failed to update payment log:", err);
            }
        }
    </script>

</body>
</html>
